<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Force Layout Example 1</title>
    <style>
        .node {
            fill: #ccc;
            stroke: #fff;
            stroke-width: 2px;
        }

        .link {
            stroke: #777;
            stroke-width: 2px;
        }

    </style>
</head>

<style>
html, body { margin:0; padding:0; overflow:hidden }
svg { position:fixed; top:0; left:0; height:100%; width:100% }
</style>

<body>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script type="module">
        const svg = d3.select('body').append('svg');
        const g = svg.append('g');
        const width = window.innerWidth;
        const height = window.innerHeight;

        let nodeScaleFactor = 3;
        let linkScaleFactor = 1;

        let centerForceStrengthFactor = 1;
        let repulsionForceStrengthFactor = 1;
        let attractionForceStrengthFactor = 1;

        const zoomTransformExtentFactor = 1;
        const zoomScaleExtentFactor = 1;

        let graph = {
            nodes: [
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
            ],
            links: [
                {source: 0, target: 1},
                {source: 0, target: 4},
                {source: 0, target: 9},
                {source: 2, target: 3},
                {source: 1, target: 2}
            ]
        };

        let ticked = () => {
            linkSelection
                .attr('x1', (d) => d.source.x)
                .attr('y1', (d) => d.source.y)
                .attr('x2', (d) => d.target.x)
                .attr('y2', (d) => d.target.y)
            nodeSelection
                .attr('cx', (d) => d.x)
                .attr('cy', (d) => d.y)
        }

        let dragStart = (event) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        let drag = (event) => {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        let dragEnd = (d) => {
            //if (!event.active) simulation.alphaTarget(0);
            //event.fx = null;
            //event.fy = null;
        }

        let totalSize = 0;

        // Count the number of links that the nodes have; used for scaling up
        // nodes
        graph.links.forEach((link) => {
            if (!graph.nodes[link.source]["size"]) graph.nodes[link.source]["size"] = 0;
            if (!graph.nodes[link.target]["size"]) graph.nodes[link.target]["size"] = 0;
            graph.nodes[link.source]["size"]++;
            graph.nodes[link.target]["size"]++;
        });

        let nodeSelection = g
            .selectAll('.node')
            .data(graph.nodes)
            .enter()
            .append('circle')
            .attr("r", (d) => {
                return d.size ? d.size * nodeScaleFactor : nodeScaleFactor
            })
            .attr('fill', (d) => {'orange'})
            .call(d3.drag()
                .on("start", dragStart)
                .on("drag", drag)
                .on("end", dragEnd));

        let linkSelection = g
            .selectAll('.link')
            .data(graph.links)
            .enter()
            .append('line')
            .attr('stroke-width', linkScaleFactor)
            .style('stroke', 'pink')

        const simulation = d3.forceSimulation(graph.nodes)
            // Attract nodes to center
            .force('center', d3.forceCenter(width / 2, height / 2)
                                .strength(centerForceStrengthFactor))
            // Repulse nodes from each other
            .force("repulsion", d3.forceManyBody().strength((-repulsionForceStrengthFactor)))
            // Attract linked nodes
            .force("links", d3.forceLink(graph.links)
                            .distance(30)
                            .strength(attractionForceStrengthFactor))
            // Repulse nodes if they collide
            .force('collide', d3.forceCollide().radius((d) => d.size * nodeScaleFactor + 1))
            .on('tick', ticked);

        let handleZoom = (event) => {
            g.attr('transform', event.transform)
        }

        svg.call(d3.zoom()
            .translateExtent([[zoomTransformExtentFactor * (-width), zoomTransformExtentFactor * (-height)],
                            [2 * zoomTransformExtentFactor * width, 2 * zoomTransformExtentFactor * height]])
            .scaleExtent([zoomScaleExtentFactor * 0.5, zoomScaleExtentFactor * 10])
            .on("zoom", handleZoom)
            .filter(() => {
                return (event.button == 0 || event.button == 1)
            })
        );
    </script>
</body>

</html>
